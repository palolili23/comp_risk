---
title: "Guide CR"
author: "Paloma"
date: "8-7-2019"
output: 
  html_document: 
    theme: "flatly"
    highlight: "tango"
---

```{r setup, include=FALSE, echo = FALSE, warning=FALSE, message=FALSE}
source("./00_call_libraries.R")
source("../01_functions/risk_diff_ratio.R")
source("../01_functions/survival_graph.R")
library(kableExtra)
library(knitr)
```

The intention of this document is to present how to calculate the **controlled direct effect** and the **total effect** when competing events are present using the estimands proposed in the following paper [by Young et al](https://arxiv.org/abs/1806.06136).


The example dataset is **Byar & Greene prostate cancer data**, downloaded from the following [website](http://biostat.mc.vanderbilt.edu/wiki/Main/DataSets).

# Data setup

To get the same dataset required in the paper we followed the next steps:

```{r}

data <- import("../00_rawdata/prostate_data.RData")


data <- data %>%
  filter(rx == 1 | rx == 4) %>%
  mutate(
    rx = ifelse(rx == 4, 1, 0),
    death = case_when(status == 1 ~ 0,
                      status == 2 ~ 1,
                      TRUE ~ 2),
    death_pr = ifelse(death == 1, 1, 0),
    death_other = ifelse(death == 2, 1, 0),
    cens = ifelse(status == 1, 1, 0),
    age_f = case_when(age <= 59 ~ 1,
                      age > 59 & age < 75 ~ 2,
                      age >= 75 ~ 3),
    age_f = as.factor(age_f),
    hg_f = ifelse(hg < 12, 1, 0),
    hg_f = as.factor(hg_f),
    pf_f = ifelse(pf == 1, 0, 1),
    pf_f = as.factor(pf_f)
  ) %>%
  rename(
    id = patno,
    max = dtime,
    exposure = rx,
    outcome = death_pr,
    competing = death_other
  ) 

```

Now that we have the data set, we will proceed by estimating the diferent estimands.

# Direct effect IPW (Only WD)

```{r}
source("../01_functions/36_direct_ipw_prost.R")
source("../01_functions/36_bootsamples.R")
source("../01_functions/36_wrapper.R")
```

Define the variables for the required models, for this we need to create a vector with the parameters we are interested in each model. 

* Censoring model: `c_model`

* Competing event model: `d_model`

* Event model: `y_model`

* *Exposure model: Since the example uses data from an RCT they do not create weights for the exposure, I will need to create them when I implement the models in observational data.*

```{r}
y_model <- c("exposure*(time + I(time^3))") 
d_model <- c("exposure", "time", "I(time^2)", "pf_f", "age_f", "hg_f", "hx")
c_model <- c("exposure", "pf_f", "age_f", "hg_f")
number_rows <- 60
```

Use the function `direct_ipw_pr_helper`, which requeries the following arguments:
data, surv_model (estimand function), factors_outcome (parameters for the outcome), factors_cens (parameters for the censoring), factors_cr (parameters for the competing event), rows (the administrative censoring time, by default uses the max time of follow up but can be changed to an earlier time of censoring), seed, n (number of bootstraps).

```{r}
results_ipw <- direct_ipw_pr_helper(
  data,
  surv_model = direct_ipw_pr,
  factors_outcome = y_model,
  factors_cens = c_model,
  factors_cr = d_model,
  rows = number_rows,
  seed = 123,
  n = 100
)
```

We use the output obtained to estimate the following estimands, for all timepoints:

* $Pr[Y_{k+1}^{a=0, c=0} = 1]$

* $Pr[Y_{k+1}^{a=1, c=0} = 1]$
  
* $Pr[Y_{k+1}^{a=1, c=0} = 1] - Pr[Y_{k+1}^{a=0, c=0} = 1]$

  
* $\frac{Pr[Y_{k+1}^{a=1, c=0} = 1]}{Pr[Y_{k+1}^{a=0, c=0} = 1]}$


``` {r, warning=FALSE, message= FALSE}
effect_measures_ipw_cr <- risk_diff_ratio(results_ipw)

effect_measures_ipw_cr %>%
  head() %>%
  kable() %>%
  kable_styling(
    bootstrap_options = c("hover", "condensed", "responsive"),
    full_width = F,
    font_size = 14
  )

```
For time point 60

```{r, message= FALSE, warning = FALSE}
effect_measures_ipw_cr %>%
  filter(time == 60) %>%
  kable() %>%
  kable_styling(
    bootstrap_options = c("hover", "condensed", "responsive"),
    full_width = F,
    font_size = 14
  )
```


Finally we plot the cumulative incidence over time and the survival probability over time.

```{r, warning=FALSE, message= FALSE}
cif_curves(
  results_ipw,
  control = "placebo",
  intervention = "High-dose DES",
  title = "Direct effect of DES in Prostate cancer death with IPW",
  xaxis = "months",
  limit_end = 60,
  breaks = 10,
  max_cif = 0.5
)
```


```{r, warning=FALSE, message= FALSE}
surv_curves(
  results_ipw,
  control = "placebo",
  intervention = "High-dose DES",
  title = "Direct effect of DES in Prostate cancer death with IPW",
  xaxis = "months",
  limit_end = 60,
  breaks = 10,
  max_cif = 0.5
)
```
